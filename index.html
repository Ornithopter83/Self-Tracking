<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <style>
        body {
            margin: 0;
            background: #000;
            color: white;
            font-family: sans-serif;
            text-align: center;
        }

        #log {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            font-size: 12px;
            color: #0f0;
            text-align: left;
            padding: 10px;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
        }

        video {
            width: 100%;
            max-width: 480px;
            transform: scaleX(-1);
            border: 1px solid #333;
        }

        .indicator {
            padding: 20px;
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="log">로그 기다리는 중...</div>
    <div id="mode" class="indicator">초기화 중...</div>
    <video id="webcam" autoplay playsinline muted></video>

    <script>
        const logArea = document.getElementById('log');
        function addLog(msg) {
            const div = document.createElement('div');
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logArea.insertBefore(div, logArea.firstChild);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('room');
        const isReceiver = urlParams.get('mode') === 'pc';
        const videoElement = document.getElementById('webcam');

        addLog(`모드 확인: ${isReceiver ? "PC" : "Mobile"}`);
        addLog(`Room ID: ${roomID}`);

        const peer = new Peer(isReceiver ? roomID : null);

        peer.on('open', (id) => {
            addLog(`PeerJS 서버 연결 성공 (ID: ${id})`);
            if (!isReceiver) startMobileCamera();
        });

        // [스마트폰 전용] 카메라 시작
        async function startMobileCamera() {
            try {
                addLog("카메라 권한 요청 중...");
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                videoElement.srcObject = stream;
                addLog("카메라 연결 성공! 영상을 PC로 보냅니다.");

                const call = peer.call(roomID, stream);
                call.on('stream', () => addLog("PC와 영상 스트림 연결됨"));
            } catch (err) {
                addLog(`카메라 에러: ${err.name}`);
            }
        }

        // [PC 전용] 영상 수신 시 분석 시작
        peer.on('call', (call) => {
            addLog("스마트폰으로부터 전화 수신!");
            call.answer();
            call.on('stream', (remoteStream) => {
                addLog("영상을 받았습니다. MediaPipe 로딩 시작...");
                videoElement.srcObject = remoteStream;
                startMediaPipe();
            });
        });

        async function startMediaPipe() {
            try {
                const pose = new Pose({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
                });

                pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5 });

                pose.onResults((results) => {
                    if (results.poseLandmarks) {
                        const nose = results.poseLandmarks[0];
                        // PC 화면 제목에 좌표 표시
                        document.getElementById('mode').innerText = `분석 중: Nose X(${nose.x.toFixed(2)})`;

                        // C#으로 데이터 전송
                        if (window.chrome && window.chrome.webview) {
                            window.chrome.webview.postMessage({ type: "POSE_DATA", landmarks: results.poseLandmarks });
                        }
                    }
                });

                addLog("MediaPipe Pose 모델 로딩 완료.");

                async function frameLoop() {
                    await pose.send({ image: videoElement });
                    requestAnimationFrame(frameLoop);
                }
                videoElement.onloadedmetadata = () => {
                    // 1. 영상의 실제 크기 가져오기
                    const videoWidth = videoElement.videoWidth;
                    const videoHeight = videoElement.videoHeight;

                    // 2. C#으로 크기 정보 전송
                    if (window.chrome && window.chrome.webview) {
                        window.chrome.webview.postMessage({
                            type: "RESIZE_WINDOW",
                            width: videoWidth,
                            height: videoHeight
                        });
                    }

                    videoElement.play();
                    frameLoop(); // 분석 시작
                };
                videoElement.onplaying = () => { // 영상이 실제로 화면에 그려지기 시작할 때
                    setTimeout(() => {
                        const payload = {
                            type: "RESIZE_WINDOW",
                            width: videoElement.videoWidth,
                            height: videoElement.videoHeight
                        };
                        if (window.chrome && window.chrome.webview) {
                            window.chrome.webview.postMessage(payload);
                        }
                    }, 500); // 0.5초 대기 후 정확한 해상도 전송
                };

            } catch (err) {
                addLog(`MediaPipe 에러: ${err.message}`);
            }
        }

        peer.on('error', (err) => addLog(`Peer 오류: ${err.type}`));
    </script>
</body>
</html>